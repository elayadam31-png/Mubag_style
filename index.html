<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masroxx Telefon il…ô Giri≈ü & Qeydiyyat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #1a202c; /* T√ºnd fon r…ôngi */
            color: #e2e8f0; /* A√ßƒ±q m…ôtn r…ôngi */
        }
        .input-style {
            @apply w-full px-4 py-3 bg-gray-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all duration-300;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- ∆èsas Kapsayƒ±cƒ± (Container) -->
    <div id="app" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">

        <!-- Ba≈ülƒ±q -->
        <header class="bg-gray-700 text-center py-6 px-4">
            <h1 id="pageTitle" class="text-3xl font-bold text-white">Xo≈ü g…ôlmisiniz!</h1>
        </header>

        <!-- Forma B√∂lm…ôsi (Telefon Giri≈üi) -->
        <main id="authFormSection" class="p-8 space-y-6 transition-transform duration-500 ease-in-out">
            <h2 id="formTitle" class="text-2xl font-semibold text-center text-gray-100">Telefonla Daxil ol</h2>
            
            <!-- Telefon N√∂mr…ôsi Formasƒ± (1-ci Addƒ±m) -->
            <form id="phoneForm" class="space-y-4">
                <p class="text-sm text-gray-400 text-center">T…ôsdiql…ôm…ô kodunu almaq √º√ß√ºn telefon n√∂mr…ônizi daxil edin.</p>
                <div class="flex space-x-2">
                    <!-- √ñlk…ô Kodu Se√ßimi -->
                    <div class="w-1/3">
                        <label for="countryCode" class="sr-only">√ñlk…ô Kodu</label>
                        <select id="countryCode" class="input-style pr-2">
                            <option value="+994" selected>+994 (AZ)</option>
                            <option value="+90">+90 (TR)</option>
                            <option value="+7">+7 (RU/KZ)</option>
                            <option value="+44">+44 (UK)</option>
                            <option value="+1">+1 (USA)</option>
                            <!-- ∆èlav…ô √∂lk…ôl…ôr …ôlav…ô edil…ô bil…ôr -->
                        </select>
                    </div>
                    <!-- Telefon N√∂mr…ôsi Giri≈üi -->
                    <div class="w-2/3">
                        <label for="phoneNumber" class="sr-only">Telefon N√∂mr…ôsi</label>
                        <input type="tel" id="phoneNumber" placeholder="N√∂mr…ô (m…ôs: 501234567)" required
                               class="input-style">
                    </div>
                </div>
                
                <!-- reCAPTCHA g√∂r√ºnm…ôz konteyneri -->
                <div id="recaptcha-container" class="mt-4 flex justify-center"></div>

                <button type="submit" id="sendCodeBtn"
                        class="w-full py-3 mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition-all duration-300 ease-in-out disabled:bg-gray-600">
                    Kodu G√∂nd…ôr
                </button>
            </form>

            <!-- OTP T…ôsdiql…ôm…ô Formasƒ± (2-ci Addƒ±m) - ∆èvv…ôlc…ô gizli -->
            <form id="otpForm" class="space-y-4 hidden">
                <p class="text-sm text-gray-400 text-center" id="otp-instruction">
                    **<span id="target-phone"></span>** n√∂mr…ôsin…ô g√∂nd…ôril…ôn 6 r…ôq…ômli kodu daxil edin.
                </p>
                <div>
                    <label for="otpCode" class="sr-only">T…ôsdiql…ôm…ô Kodu (OTP)</label>
                    <input type="number" id="otpCode" placeholder="T…ôsdiql…ôm…ô Kodu" required
                           class="input-style text-center text-xl tracking-wider" maxlength="6">
                </div>
                <button type="submit" id="verifyBtn"
                        class="w-full py-3 mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition-all duration-300 ease-in-out disabled:bg-gray-600">
                    T…ôsdiql…ô
                </button>
                <button type="button" onclick="resetFlow()"
                        class="w-full py-2 text-sm text-gray-400 hover:text-gray-200 transition-colors duration-200">
                    N√∂mr…ôni D…ôyi≈üdir
                </button>
            </form>
        </main>

        <!-- ∆èsas s…ôhif…ô g√∂r√ºn√º≈ü√º (Giri≈ü Uƒüurlu olduqda) -->
        <main id="homeSection" class="hidden p-8 space-y-6">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-emerald-400">Giri≈ü Uƒüurludur! üéâ</h2>
                <p id="userPhoneDisplay" class="text-lg text-gray-300 mt-2 font-mono break-all"></p>
                <p class="text-sm text-gray-400">S√∂hb…ôt proqramƒ± y√ºkl…ônm…ôy…ô hazƒ±rdƒ±r.</p>
            </div>
            <div class="mt-8 text-center">
                <button onclick="logout()"
                        class="py-3 px-6 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transition-all duration-300 ease-in-out">
                    √áƒ±xƒ±≈ü
                </button>
            </div>
        </main>

        <!-- Mesaj Qutusu (Modal) -->
        <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-700 text-white p-6 rounded-xl shadow-2xl text-center max-w-xs w-full">
                <p id="messageText" class="text-lg mb-4"></p>
                <button onclick="hideMessage()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-semibold">Baƒüla</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK ƒ∞dxallarƒ± -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPhoneNumber, signInWithCustomToken, onAuthStateChanged, RecaptchaVerifier, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global d…ôyi≈ü…ônl…ôr
        let auth, db;
        let confirmationResult = null; // T…ôsdiql…ôm…ô n…ôtic…ôsini saxlamaq √º√ß√ºn
        let recaptchaVerifier = null;
        let isAuthReady = false;

        // HTML elementl…ôri
        const authFormSection = document.getElementById('authFormSection');
        const homeSection = document.getElementById('homeSection');
        const phoneForm = document.getElementById('phoneForm');
        const otpForm = document.getElementById('otpForm');
        const countryCode = document.getElementById('countryCode');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const otpCodeInput = document.getElementById('otpCode');
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        const verifyBtn = document.getElementById('verifyBtn');
        const userIdDisplay = document.getElementById('userPhoneDisplay');
        const targetPhoneDisplay = document.getElementById('target-phone');
        
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Firebase Konfiqurasiyasƒ± (Canvas m√ºhitind…ôn g…ôlir)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Mesaj Qutusu Funksiyalarƒ± ---

        function showMessage(msg) {
            messageText.innerText = msg;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        window.hideMessage = function() {
            messageBox.classList.remove('flex');
            messageBox.classList.add('hidden');
        }

        // --- Firebase Ba≈ülatma v…ô T…ôsdiql…ôm…ô ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                showMessage("X…ôta: Firebase konfiqurasiyasƒ± tapƒ±lmadƒ±!");
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Canvas x√ºsusi tokeni il…ô daxil olmaƒüa c…ôhd edin
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                // ƒ∞stifad…ô√ßi v…ôziyy…ôtini dinl…ôyin
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        // ∆èg…ôr telefon n√∂mr…ôsi varsa, onu g√∂st…ôr, yoxsa UID g√∂st…ôr
                        const userIdentifier = user.phoneNumber || user.uid; 
                        checkAuth(userIdentifier);
                    } else {
                        isAuthReady = true;
                        checkAuth(null);
                        // reCAPTCHA-nƒ± yalnƒ±z istifad…ô√ßi daxil olmadƒ±qda ba≈ülatƒ±n
                        setupRecaptcha();
                    }
                });

            } catch (error) {
                console.error("Firebase Ba≈ülatma X…ôtasƒ±:", error);
                showMessage(`Baƒülantƒ± X…ôtasƒ±: ${error.message}`);
                // reCAPTCHA-nƒ± ba≈ülatmaq √º√ß√ºn …ôl il…ô √ßaƒüƒ±rƒ±n, √ß√ºnki onAuthStateChanged i≈ül…ôm…ôy…ô bil…ôr
                setupRecaptcha();
            }
        }

        // --- reCAPTCHA T…ôyin etm…ôk ---

        function setupRecaptcha() {
            // ∆èg…ôr auth v…ô reCAPTCHA h…ôl…ô t…ôyin olunmayƒ±bsa
            if (auth && !recaptchaVerifier) {
                recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'normal', // "normal" v…ô ya "invisible" istifad…ô edin. Normal daha etibarlƒ±dƒ±r.
                    'callback': (response) => {
                        // reCAPTCHA t…ôsdiq edildikd…ô bu geri z…ông i≈ü…ô d√º≈ü√ºr
                        console.log("reCAPTCHA t…ôsdiql…ôndi.");
                    },
                    'expired-callback': () => {
                        // reCAPTCHA vaxtƒ± bitdikd…ô
                        showMessage("T…ôhl√ºk…ôsizlik t…ôsdiqi vaxtƒ± bitdi. Yenid…ôn c…ôhd edin.");
                        recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                    }
                });
                recaptchaVerifier.render().catch(error => console.error("reCAPTCHA render x…ôtasƒ±:", error));
            }
        }

        // --- Autentifikasiya Prosesi ---

        /**
         * 1-ci addƒ±m: Telefon n√∂mr…ôsin…ô t…ôsdiql…ôm…ô kodu g√∂nd…ôrm…ôk
         */
        phoneForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullPhoneNumber = countryCode.value + phoneNumberInput.value.trim();

            if (!fullPhoneNumber) {
                showMessage("Z…ôhm…ôt olmasa, tam telefon n√∂mr…ônizi daxil edin.");
                return;
            }

            // UI-ƒ± bloklayƒ±n
            sendCodeBtn.disabled = true;
            sendCodeBtn.textContent = 'Kod G√∂nd…ôrilir...';
            
            try {
                // T…ôsdiql…ôm…ô kodunu g√∂nd…ôrin
                confirmationResult = await signInWithPhoneNumber(auth, fullPhoneNumber, recaptchaVerifier);
                
                // UI-ƒ± 2-ci addƒ±ma ke√ßirin
                targetPhoneDisplay.textContent = fullPhoneNumber;
                phoneForm.classList.add('hidden');
                otpForm.classList.remove('hidden');
                otpCodeInput.focus();

            } catch (error) {
                console.error("Kod g√∂nd…ôrm…ô x…ôtasƒ±:", error);
                let message = "Kod g√∂nd…ôrilm…ôdi. Xahi≈ü edirik, n√∂mr…ôni v…ô reCAPTCHA-nƒ± yoxlayƒ±n.";
                
                if (error.code === 'auth/invalid-phone-number') {
                    message = "Daxil edilmi≈ü n√∂mr…ô formatƒ± yanlƒ±≈üdƒ±r.";
                } else if (error.code === 'auth/too-many-requests') {
                    message = "√áoxlu c…ôhd edildi. Z…ôhm…ôt olmasa bir az sonra yenid…ôn c…ôhd edin.";
                }

                showMessage(message);
                
                // reCAPTCHA-nƒ± yenil…ôyin
                if (recaptchaVerifier) {
                   recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                }
                resetFlow(); // X…ôta olduqda geri qayƒ±t
            } finally {
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = 'Kodu G√∂nd…ôr';
            }
        });

        /**
         * 2-ci addƒ±m: OTP kodu il…ô daxil olmaq
         */
        otpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const otpCode = otpCodeInput.value.trim();

            if (!otpCode || confirmationResult === null) {
                showMessage("Z…ôhm…ôt olmasa, kodu v…ô ya telefon n√∂mr…ôsini yoxlayƒ±n.");
                return;
            }
            
            // UI-ƒ± bloklayƒ±n
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'T…ôsdiql…ônir...';

            try {
                // Kodu t…ôsdiql…ôyin
                const credential = await confirmationResult.confirm(otpCode);
                const user = credential.user;
                
                // Autentifikasiya uƒüurludur, UI onAuthStateChanged t…ôr…ôfind…ôn idar…ô olunacaq

            } catch (error) {
                console.error("Kod T…ôsdiql…ôm…ô X…ôtasƒ±:", error);
                let message = "Daxil edil…ôn kod yanlƒ±≈üdƒ±r v…ô ya vaxtƒ± bitmi≈üdir.";
                
                if (error.code === 'auth/invalid-verification-code') {
                    message = "Yanlƒ±≈ü t…ôsdiql…ôm…ô kodu.";
                }

                showMessage(message);
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'T…ôsdiql…ô';
            }
        });
        
        /**
         * Prosesi sƒ±fƒ±rlayƒ±n (Ba≈ülanƒüƒ±c formasƒ±na qayƒ±dƒ±n)
         */
        window.resetFlow = function() {
            phoneForm.classList.remove('hidden');
            otpForm.classList.add('hidden');
            otpCodeInput.value = '';
            phoneNumberInput.focus();
        }


        // --- UI N…ôzar…ôti ---

        /**
         * ƒ∞stifad…ô√ßinin login v…ôziyy…ôtin…ô …ôsas…ôn UI-ƒ± d…ôyi≈üdirin.
         * @param {string | null} userIdentifier - ƒ∞stifad…ô√ßinin telefon n√∂mr…ôsi v…ô ya UID.
         */
        function checkAuth(userIdentifier) {
            if (userIdentifier && userIdentifier !== 'anonim') {
                authFormSection.classList.add('hidden');
                homeSection.classList.remove('hidden');
                userIdDisplay.innerText = userIdentifier;
                document.getElementById('pageTitle').innerText = "Hesabƒ±nƒ±z";
            } else {
                authFormSection.classList.remove('hidden');
                homeSection.classList.add('hidden');
                document.getElementById('pageTitle').innerText = "Telefon il…ô Giri≈ü";
                // Giri≈ü formasƒ±na qayƒ±dark…ôn prosesi sƒ±fƒ±rlayƒ±n
                resetFlow(); 
            }
        }

        // --- √áƒ±xƒ±≈ü Funksiyasƒ± ---
        
        window.logout = async function() {
            try {
                await signOut(auth);
                // checkAuth onAuthStateChanged t…ôr…ôfind…ôn avtomatik i≈ü…ô d√º≈ü…ôc…ôk
                showMessage("Uƒüurla √ßƒ±xƒ±≈ü etdiniz.");
            } catch (error) {
                console.error("√áƒ±xƒ±≈ü X…ôtasƒ±:", error);
                showMessage("√áƒ±xƒ±≈ü zamanƒ± x…ôta ba≈ü verdi.");
            }
        }

        // S…ôhif…ô y√ºkl…ôndikd…ô ba≈ülatƒ±n
        window.addEventListener('load', initializeFirebase);
    </script>
</body>
</html>


<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Keskin ve Stabil PDF Görüntüleyici</title>
  
  <!-- Tailwind CSS'i yükle -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind konfigürasyonu
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'Arial', 'sans-serif'],
          },
          colors: {
            'primary-blue': '#0b63a3',
            'secondary-blue': '#1e7dbd',
            'light-blue': '#e0f2ff',
            'error-red': '#d32f2f',
          }
        }
      }
    }
  </script>
  <style>
    /* Temel vücut stilleri */
    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #f5f7fb;
      overflow: hidden; /* Dış kaydırmayı engelle */
    }

    /* PDF Sayfalarını Barındıran Alan */
    #pdf-renderer {
        flex-grow: 1;
        overflow-y: auto; 
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem; 
    }

    /* Her bir canvas (sayfa) için stil */
    .pdf-page-canvas {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 6px;
        background-color: white;
        width: 100%; 
        max-width: 800px; 
        height: auto;
    }
    
    /* Header ve Butonların bulunduğu konteyner */
    .header-container {
      position: relative;
      background-color: #0b63a3;
      z-index: 20; 
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Geçmiş Paneli (Sidebar) Stili */
    #history-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 320px;
        max-width: 85vw;
        height: 100vh;
        background-color: white;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        z-index: 30;
        box-shadow: 4px 0 10px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
    }

    #history-panel.open {
        transform: translateX(0);
    }

    #history-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 25;
        display: none;
    }
  </style>
  
  <!-- Firebase Kütüphaneleri -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // PDF.js Kütüphanesi
    import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.mjs';

    // PDF.js Worker yolunu ayarla
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.mjs';

    // Firebase Global Değişkenleri
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // Firebase Servisleri
    let app, db, auth, userId = null;

    // DOM Öğeleri
    const dropzone = document.getElementById('dropzone');
    const pdfRenderer = document.getElementById('pdf-renderer');
    const messageBox = document.getElementById('message-box');
    const backButton = document.getElementById('back-button');
    const loadingText = document.getElementById('loading-text');
    const historyButton = document.getElementById('history-button');
    const historyPanel = document.getElementById('history-panel');
    const historyList = document.getElementById('history-list');
    const historyOverlay = document.getElementById('history-overlay');
    const userIdDisplay = document.getElementById('user-id-display');

    // --- FIREBASE İŞLEMLERİ ---

    // Firebase Başlatma ve Kimlik Doğrulama
    async function initializeFirebase() {
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase yapılandırması eksik. Veritabanı devre dışı.");
                 showMessage("Veritabanı bağlantısı kurulamadı. Geçmiş özelliği çalışmayacak.", true);
                 return;
            }
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); // Hata ayıklama için Firestore loglarını aç

            // Kimlik doğrulama tokenı varsa onunla giriş yap, yoksa anonim giriş yap
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // Kimlik doğrulama durumu değiştiğinde kullanıcı ID'sini al ve geçmişi yükle
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `Kullanıcı ID: ${userId}`;
                    listenToPdfHistory();
                } else {
                    // Anonim kullanıcı dahi olsa bir ID olmalı
                    userId = crypto.randomUUID(); 
                    userIdDisplay.textContent = `Kullanıcı ID: (Anonim - Veri Kaydı Yok)`;
                    console.log("Kullanıcı anonim olarak giriş yaptı.");
                }
            });

        } catch (error) {
            console.error("Firebase başlatma veya kimlik doğrulama hatası:", error);
            showMessage("Uygulama başlatılırken bir hata oluştu.", true);
        }
    }

    // PDF Geçmişini Firestore'a kaydetme
    async function savePdfHistory(fileName) {
        if (!db || !userId) return; // Güvenlik kontrolü

        const path = `/artifacts/${appId}/users/${userId}/pdf_history`;
        const historyCollection = collection(db, path);
        
        try {
            // Firestore'a kaydetme işlemi
            await addDoc(historyCollection, {
                name: fileName,
                openedAt: new Date().getTime(),
            });
        } catch (error) {
            console.error("Geçmiş kaydı başarısız:", error);
            // Hata mesajını göster ancak uygulamanın çökmesini engelle
            throw new Error("Geçmiş kaydedilemedi. Ağ/Veritabanı hatası."); 
        }
    }

    // PDF Geçmişini silme
    async function deletePdfHistory(docId) {
        if (!db || !userId) return;

        const path = `/artifacts/${appId}/users/${userId}/pdf_history/${docId}`;
        
        try {
            await deleteDoc(doc(db, path));
            showMessage("Geçmiş kaydı silindi.", false);
        } catch (error) {
            console.error("Silme başarısız:", error);
            showMessage("Silme işlemi başarısız oldu.", true);
        }
    }

    // PDF Geçmişini dinleme ve arayüze yükleme
    function listenToPdfHistory() {
        if (!db || !userId) return;

        const path = `/artifacts/${appId}/users/${userId}/pdf_history`;
        const historyCollection = collection(db, path);
        const q = query(historyCollection, orderBy("openedAt", "desc"));

        onSnapshot(q, (snapshot) => {
            historyList.innerHTML = ''; 
            if (snapshot.empty) {
                historyList.innerHTML = '<p class="text-gray-500 p-4 text-center text-sm">Hiç geçmiş kaydı yok.</p>';
                return;
            }

            snapshot.docs.forEach(docSnapshot => {
                const data = docSnapshot.data();
                const docId = docSnapshot.id;
                const date = new Date(data.openedAt).toLocaleString('tr-TR');

                const listItem = document.createElement('div');
                listItem.className = 'flex justify-between items-center p-3 border-b border-gray-100 hover:bg-light-blue transition duration-150';
                listItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800 break-words">${data.name}</p>
                        <p class="text-xs text-gray-500 mt-1">${date}</p>
                    </div>
                    <div class="flex space-x-2">
                        <!-- Açma Butonu (Dosya olmadığı için sadece bilgilendirme) -->
                        <button data-name="${data.name}" data-action="open"
                            class="bg-secondary-blue text-white p-2 rounded-full hover:bg-primary-blue transition focus:outline-none w-8 h-8 flex items-center justify-center"
                            title="Tekrar Aç">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                        <!-- Silme Butonu -->
                        <button data-id="${docId}" data-action="delete"
                            class="bg-error-red text-white p-2 rounded-full hover:bg-red-700 transition focus:outline-none w-8 h-8 flex items-center justify-center"
                            title="Kaydı Sil">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                historyList.appendChild(listItem);
            });
        }, (error) => {
            console.error("Geçmişi dinlerken hata:", error);
            showMessage("Geçmiş verileri yüklenemedi.", true);
        });
    }

    // --- PDF.JS VE ARACILAR ---
    
    /**
     * Özel bir hata/bilgi mesajı gösterir.
     * @param {string} text Gösterilecek mesaj metni.
     */
    function showMessage(text, isError = true) {
      messageBox.textContent = text;
      const baseClasses = 'fixed top-4 left-1/2 -translate-x-1/2 py-3 px-6 rounded-lg shadow-2xl opacity-0 transition-all duration-500 z-50 transform -translate-y-2 text-white';
      messageBox.className = isError 
        ? `${baseClasses} bg-error-red`
        : `${baseClasses} bg-primary-blue`;

      messageBox.style.opacity = '1';
      messageBox.style.transform = 'translateX(-50%) translateY(0)';
      
      setTimeout(() => {
        messageBox.style.opacity = '0';
        messageBox.style.transform = 'translateX(-50%) translateY(-20px)';
      }, 4000); 
    }

    // Dropzone'a tıklanınca dosya seçme penceresini açar
    dropzone.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/pdf';
      input.onchange = e => {
        if (e.target.files.length > 0) {
          openPDF(e.target.files[0]);
        }
      };
      input.click();
    });

    // Sürükleme olayları
    dropzone.addEventListener('dragover', e => {
      e.preventDefault();
      dropzone.classList.add('border-secondary-blue', 'bg-light-blue');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('border-secondary-blue', 'bg-light-blue');
    });

    dropzone.addEventListener('drop', e => {
      e.preventDefault();
      dropzone.classList.remove('border-secondary-blue', 'bg-light-blue');
      
      const file = e.dataTransfer.files[0];
      
      if (file && file.type === 'application/pdf') {
        openPDF(file);
      } else {
        showMessage('Hata: Lütfen geçerli bir PDF dosyası bırakın.');
      }
    });

    /**
     * Seçilen PDF dosyasını okur ve sayfalarını canvas'a render eder.
     * @param {File} file Görüntülenecek PDF File objesi.
     */
    async function openPDF(file) {
      // Yükleniyor durumunu başlat
      loadingText.classList.remove('hidden');
      dropzone.style.pointerEvents = 'none'; 
      pdfRenderer.innerHTML = ''; 
      closeHistoryPanel(); // Geçmiş panelini kapat

      try {
        const reader = new FileReader();
        const pdfData = await new Promise((resolve, reject) => {
            reader.onload = (e) => resolve(new Uint8Array(e.target.result));
            reader.onerror = (error) => reject(new Error("Dosya okuma hatası."));
            reader.readAsArrayBuffer(file);
        });
        
        const loadingTask = pdfjsLib.getDocument({ data: pdfData });
        const pdf = await loadingTask.promise;

        loadingText.textContent = `PDF Yükleniyor... ${pdf.numPages} sayfa işleniyor.`;

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            
            // Maksimum genişliği al (800px veya kapsayıcı genişliği)
            const maxPageWidth = Math.min(pdfRenderer.clientWidth - 32, 800); 
            
            // Sayfanın 1 ölçekteki temel görünüm alanını hesapla
            const baseViewport = page.getViewport({ scale: 1 });
            
            // Gerekli ölçeği hesapla (ekrana sığdırmak için)
            const desiredScale = maxPageWidth / baseViewport.width;
            
            // Görüntü alanı ve Canvas boyutunu istenen ölçeğe ayarla (Basit ve Stabil Yöntem)
            const viewport = page.getViewport({ scale: desiredScale });

            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-page-canvas';
            
            // Canvas'ın fiziksel ve CSS boyutlarını ayarla (1:1 stabilite)
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            canvas.style.width = `${viewport.width}px`;
            canvas.style.height = `${viewport.height}px`;

            const ctx = canvas.getContext('2d');
            
            // Kritik: Yüksek DPI çarpanı KALDIRILDI. Bu, bembeyaz ekran sorununu çözmeli.
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport // Doğrudan istenen ölçekte çizim yap
            };
            await page.render(renderContext).promise; 

            pdfRenderer.appendChild(canvas);
        }

        // Başarılı yüklemede arayüzü güncelle
        loadingText.classList.add('hidden');
        dropzone.style.display = 'none';
        pdfRenderer.classList.remove('hidden');
        backButton.classList.remove('hidden');
        historyButton.classList.add('hidden'); // PDF açıkken Geçmiş butonunu gizle
        dropzone.style.pointerEvents = 'auto'; 
        loadingText.textContent = `PDF Yükleniyor... Lütfen bekleyin.`; // Reset text
        
        // Geçmişi kaydetmeyi bekliyoruz. Hata olursa aşağıda yakalanacak.
        if (userId) {
            await savePdfHistory(file.name);
        }

        showMessage(`PDF başarıyla yüklendi (${pdf.numPages} sayfa).`, false);

      } catch (error) {
        // Hata oluştuğunda stabil bir şekilde arayüzü sıfırla
        console.error("PDF yüklenirken kritik bir hata oluştu:", error);
        loadingText.classList.add('hidden');
        dropzone.style.pointerEvents = 'auto'; 
        
        // Arayüzü orijinal haline döndür
        pdfRenderer.classList.add('hidden');
        pdfRenderer.innerHTML = '';
        dropzone.style.display = 'flex'; 
        backButton.classList.add('hidden');
        historyButton.classList.remove('hidden'); // Geçmiş butonunu tekrar göster
        loadingText.textContent = `PDF Yükleniyor... Lütfen bekleyin.`; // Reset text
        
        // Kullanıcıya görünür hata mesajı
        showMessage(`Hata: PDF yüklenemedi. Dosya bozuk veya render hatası.`, true);
      }
    }

    // PDF görüntüleyicisini kapatır ve yükleme ekranına geri döner.
    window.closePDF = function() {
        pdfRenderer.classList.add('hidden');
        pdfRenderer.innerHTML = ''; 
        dropzone.style.display = 'flex'; 
        backButton.classList.add('hidden');
        historyButton.classList.remove('hidden'); // Geçmiş butonunu tekrar göster
        loadingText.classList.add('hidden');
    }

    // --- GEÇMİŞ PANELİ İŞLEMLERİ ---

    function openHistoryPanel() {
        historyPanel.classList.add('open');
        historyOverlay.style.display = 'block';
    }

    function closeHistoryPanel() {
        historyPanel.classList.remove('open');
        historyOverlay.style.display = 'none';
    }

    // Geçmiş butonuna tıklandığında paneli aç/kapa
    historyButton.addEventListener('click', openHistoryPanel);
    historyOverlay.addEventListener('click', closeHistoryPanel);

    // Geçmiş listesindeki butonlara tıklama işleyicisi
    historyList.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;

        const action = target.getAttribute('data-action');
        const docId = target.getAttribute('data-id');
        const fileName = target.getAttribute('data-name');

        if (action === 'delete') {
            deletePdfHistory(docId);
        } else if (action === 'open') {
            closeHistoryPanel();
            // Kullanıcıya dosyanın tekrar yüklenmesi gerektiğini bildir
            showMessage(`"${fileName}" dosyasını tekrar açmak için lütfen orijinal dosyayı yeniden yükleyin. Veritabanında sadece adı saklanıyor.`, false);
        }
    });


    // Sayfa yüklendiğinde Firebase'i başlat
    window.onload = initializeFirebase;
  </script>
</body>
</html>


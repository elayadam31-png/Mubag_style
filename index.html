<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masroxx Telefon ilÉ™ GiriÅŸ & Qeydiyyat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #1a202c; /* TÃ¼nd fon rÉ™ngi */
            color: #e2e8f0; /* AÃ§Ä±q mÉ™tn rÉ™ngi */
        }
        .input-style {
            @apply w-full px-4 py-3 bg-gray-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all duration-300;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Æsas KapsayÄ±cÄ± (Container) -->
    <div id="app" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">

        <!-- BaÅŸlÄ±q -->
        <header class="bg-gray-700 text-center py-6 px-4">
            <h1 id="pageTitle" class="text-3xl font-bold text-white">XoÅŸ gÉ™lmisiniz!</h1>
        </header>

        <!-- Forma BÃ¶lmÉ™si (Telefon GiriÅŸi) -->
        <main id="authFormSection" class="p-8 space-y-6 transition-transform duration-500 ease-in-out">
            <h2 id="formTitle" class="text-2xl font-semibold text-center text-gray-100">Telefonla Daxil ol</h2>
            
            <!-- Telefon NÃ¶mrÉ™si FormasÄ± (1-ci AddÄ±m) -->
            <form id="phoneForm" class="space-y-4">
                <p class="text-sm text-gray-400 text-center">TÉ™sdiqlÉ™mÉ™ kodunu almaq Ã¼Ã§Ã¼n telefon nÃ¶mrÉ™nizi daxil edin.</p>
                <div class="flex space-x-2">
                    <!-- Ã–lkÉ™ Kodu SeÃ§imi -->
                    <div class="w-1/3">
                        <label for="countryCode" class="sr-only">Ã–lkÉ™ Kodu</label>
                        <select id="countryCode" class="input-style pr-2">
                            <option value="+994" selected>+994 (AZ)</option>
                            <option value="+90">+90 (TR)</option>
                            <option value="+7">+7 (RU/KZ)</option>
                            <option value="+44">+44 (UK)</option>
                            <option value="+1">+1 (USA)</option>
                            <!-- ÆlavÉ™ Ã¶lkÉ™lÉ™r É™lavÉ™ edilÉ™ bilÉ™r -->
                        </select>
                    </div>
                    <!-- Telefon NÃ¶mrÉ™si GiriÅŸi -->
                    <div class="w-2/3">
                        <label for="phoneNumber" class="sr-only">Telefon NÃ¶mrÉ™si</label>
                        <input type="tel" id="phoneNumber" placeholder="NÃ¶mrÉ™ (mÉ™s: 501234567)" required
                               class="input-style">
                    </div>
                </div>
                
                <!-- reCAPTCHA gÃ¶rÃ¼nmÉ™z konteyneri -->
                <div id="recaptcha-container" class="mt-4 flex justify-center"></div>

                <button type="submit" id="sendCodeBtn"
                        class="w-full py-3 mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl shadow-lg transition-all duration-300 ease-in-out disabled:bg-gray-600">
                    Kodu GÃ¶ndÉ™r
                </button>
            </form>

            <!-- OTP TÉ™sdiqlÉ™mÉ™ FormasÄ± (2-ci AddÄ±m) - ÆvvÉ™lcÉ™ gizli -->
            <form id="otpForm" class="space-y-4 hidden">
                <p class="text-sm text-gray-400 text-center" id="otp-instruction">
                    **<span id="target-phone"></span>** nÃ¶mrÉ™sinÉ™ gÃ¶ndÉ™rilÉ™n 6 rÉ™qÉ™mli kodu daxil edin.
                </p>
                <div>
                    <label for="otpCode" class="sr-only">TÉ™sdiqlÉ™mÉ™ Kodu (OTP)</label>
                    <input type="number" id="otpCode" placeholder="TÉ™sdiqlÉ™mÉ™ Kodu" required
                           class="input-style text-center text-xl tracking-wider" maxlength="6">
                </div>
                <button type="submit" id="verifyBtn"
                        class="w-full py-3 mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition-all duration-300 ease-in-out disabled:bg-gray-600">
                    TÉ™sdiqlÉ™
                </button>
                <button type="button" onclick="resetFlow()"
                        class="w-full py-2 text-sm text-gray-400 hover:text-gray-200 transition-colors duration-200">
                    NÃ¶mrÉ™ni DÉ™yiÅŸdir
                </button>
            </form>
        </main>

        <!-- Æsas sÉ™hifÉ™ gÃ¶rÃ¼nÃ¼ÅŸÃ¼ (GiriÅŸ UÄŸurlu olduqda) -->
        <main id="homeSection" class="hidden p-8 space-y-6">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-emerald-400">GiriÅŸ UÄŸurludur! ğŸ‰</h2>
                <p id="userPhoneDisplay" class="text-lg text-gray-300 mt-2 font-mono break-all"></p>
                <p class="text-sm text-gray-400">SÃ¶hbÉ™t proqramÄ± yÃ¼klÉ™nmÉ™yÉ™ hazÄ±rdÄ±r.</p>
            </div>
            <div class="mt-8 text-center">
                <button onclick="logout()"
                        class="py-3 px-6 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg transition-all duration-300 ease-in-out">
                    Ã‡Ä±xÄ±ÅŸ
                </button>
            </div>
        </main>

        <!-- Mesaj Qutusu (Modal) -->
        <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-700 text-white p-6 rounded-xl shadow-2xl text-center max-w-xs w-full">
                <p id="messageText" class="text-lg mb-4"></p>
                <button onclick="hideMessage()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-semibold">BaÄŸla</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Ä°dxallarÄ± -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPhoneNumber, signInWithCustomToken, onAuthStateChanged, RecaptchaVerifier, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global dÉ™yiÅŸÉ™nlÉ™r
        let auth, db;
        let confirmationResult = null; // TÉ™sdiqlÉ™mÉ™ nÉ™ticÉ™sini saxlamaq Ã¼Ã§Ã¼n
        let recaptchaVerifier = null;
        let isAuthReady = false;

        // HTML elementlÉ™ri
        const authFormSection = document.getElementById('authFormSection');
        const homeSection = document.getElementById('homeSection');
        const phoneForm = document.getElementById('phoneForm');
        const otpForm = document.getElementById('otpForm');
        const countryCode = document.getElementById('countryCode');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const otpCodeInput = document.getElementById('otpCode');
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        const verifyBtn = document.getElementById('verifyBtn');
        const userIdDisplay = document.getElementById('userPhoneDisplay');
        const targetPhoneDisplay = document.getElementById('target-phone');
        
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Firebase KonfiqurasiyasÄ± (Canvas mÃ¼hitindÉ™n gÉ™lir)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Mesaj Qutusu FunksiyalarÄ± ---

        function showMessage(msg) {
            messageText.innerText = msg;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        window.hideMessage = function() {
            messageBox.classList.remove('flex');
            messageBox.classList.add('hidden');
        }

        // --- Firebase BaÅŸlatma vÉ™ TÉ™sdiqlÉ™mÉ™ ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                showMessage("XÉ™ta: Firebase konfiqurasiyasÄ± tapÄ±lmadÄ±!");
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Canvas xÃ¼susi tokeni ilÉ™ daxil olmaÄŸa cÉ™hd edin
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                // Ä°stifadÉ™Ã§i vÉ™ziyyÉ™tini dinlÉ™yin
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        // ÆgÉ™r telefon nÃ¶mrÉ™si varsa, onu gÃ¶stÉ™r, yoxsa UID gÃ¶stÉ™r
                        const userIdentifier = user.phoneNumber || user.uid; 
                        checkAuth(userIdentifier);
                    } else {
                        isAuthReady = true;
                        checkAuth(null);
                        // reCAPTCHA-nÄ± yalnÄ±z istifadÉ™Ã§i daxil olmadÄ±qda baÅŸlatÄ±n
                        setupRecaptcha();
                    }
                });

            } catch (error) {
                console.error("Firebase BaÅŸlatma XÉ™tasÄ±:", error);
                showMessage(`BaÄŸlantÄ± XÉ™tasÄ±: ${error.message}`);
                // reCAPTCHA-nÄ± baÅŸlatmaq Ã¼Ã§Ã¼n É™l ilÉ™ Ã§aÄŸÄ±rÄ±n, Ã§Ã¼nki onAuthStateChanged iÅŸlÉ™mÉ™yÉ™ bilÉ™r
                setupRecaptcha();
            }
        }

        // --- reCAPTCHA TÉ™yin etmÉ™k ---

        function setupRecaptcha() {
            // ÆgÉ™r auth vÉ™ reCAPTCHA hÉ™lÉ™ tÉ™yin olunmayÄ±bsa
            if (auth && !recaptchaVerifier) {
                recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'normal', // "normal" vÉ™ ya "invisible" istifadÉ™ edin. Normal daha etibarlÄ±dÄ±r.
                    'callback': (response) => {
                        // reCAPTCHA tÉ™sdiq edildikdÉ™ bu geri zÉ™ng iÅŸÉ™ dÃ¼ÅŸÃ¼r
                        console.log("reCAPTCHA tÉ™sdiqlÉ™ndi.");
                    },
                    'expired-callback': () => {
                        // reCAPTCHA vaxtÄ± bitdikdÉ™
                        showMessage("TÉ™hlÃ¼kÉ™sizlik tÉ™sdiqi vaxtÄ± bitdi. YenidÉ™n cÉ™hd edin.");
                        recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                    }
                });
                recaptchaVerifier.render().catch(error => console.error("reCAPTCHA render xÉ™tasÄ±:", error));
            }
        }

        // --- Autentifikasiya Prosesi ---

        /**
         * 1-ci addÄ±m: Telefon nÃ¶mrÉ™sinÉ™ tÉ™sdiqlÉ™mÉ™ kodu gÃ¶ndÉ™rmÉ™k
         */
        phoneForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullPhoneNumber = countryCode.value + phoneNumberInput.value.trim();

            if (!fullPhoneNumber) {
                showMessage("ZÉ™hmÉ™t olmasa, tam telefon nÃ¶mrÉ™nizi daxil edin.");
                return;
            }

            // UI-Ä± bloklayÄ±n
            sendCodeBtn.disabled = true;
            sendCodeBtn.textContent = 'Kod GÃ¶ndÉ™rilir...';
            
            try {
                // TÉ™sdiqlÉ™mÉ™ kodunu gÃ¶ndÉ™rin
                confirmationResult = await signInWithPhoneNumber(auth, fullPhoneNumber, recaptchaVerifier);
                
                // UI-Ä± 2-ci addÄ±ma keÃ§irin
                targetPhoneDisplay.textContent = fullPhoneNumber;
                phoneForm.classList.add('hidden');
                otpForm.classList.remove('hidden');
                otpCodeInput.focus();

            } catch (error) {
                console.error("Kod gÃ¶ndÉ™rmÉ™ xÉ™tasÄ±:", error);
                let message = "Kod gÃ¶ndÉ™rilmÉ™di. XahiÅŸ edirik, nÃ¶mrÉ™ni vÉ™ reCAPTCHA-nÄ± yoxlayÄ±n.";
                
                if (error.code === 'auth/invalid-phone-number') {
                    message = "Daxil edilmiÅŸ nÃ¶mrÉ™ formatÄ± yanlÄ±ÅŸdÄ±r.";
                } else if (error.code === 'auth/too-many-requests') {
                    message = "Ã‡oxlu cÉ™hd edildi. ZÉ™hmÉ™t olmasa bir az sonra yenidÉ™n cÉ™hd edin.";
                }

                showMessage(message);
                
                // reCAPTCHA-nÄ± yenilÉ™yin
                if (recaptchaVerifier) {
                   recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                }
                resetFlow(); // XÉ™ta olduqda geri qayÄ±t
            } finally {
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = 'Kodu GÃ¶ndÉ™r';
            }
        });

        /**
         * 2-ci addÄ±m: OTP kodu ilÉ™ daxil olmaq
         */
        otpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const otpCode = otpCodeInput.value.trim();

            if (!otpCode || confirmationResult === null) {
                showMessage("ZÉ™hmÉ™t olmasa, kodu vÉ™ ya telefon nÃ¶mrÉ™sini yoxlayÄ±n.");
                return;
            }
            
            // UI-Ä± bloklayÄ±n
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'TÉ™sdiqlÉ™nir...';

            try {
                // Kodu tÉ™sdiqlÉ™yin
                const credential = await confirmationResult.confirm(otpCode);
                const user = credential.user;
                
                // Autentifikasiya uÄŸurludur, UI onAuthStateChanged tÉ™rÉ™findÉ™n idarÉ™ olunacaq

            } catch (error) {
                console.error("Kod TÉ™sdiqlÉ™mÉ™ XÉ™tasÄ±:", error);
                let message = "Daxil edilÉ™n kod yanlÄ±ÅŸdÄ±r vÉ™ ya vaxtÄ± bitmiÅŸdir.";
                
                if (error.code === 'auth/invalid-verification-code') {
                    message = "YanlÄ±ÅŸ tÉ™sdiqlÉ™mÉ™ kodu.";
                }

                showMessage(message);
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'TÉ™sdiqlÉ™';
            }
        });
        
        /**
         * Prosesi sÄ±fÄ±rlayÄ±n (BaÅŸlanÄŸÄ±c formasÄ±na qayÄ±dÄ±n)
         */
        window.resetFlow = function() {
            phoneForm.classList.remove('hidden');
            otpForm.classList.add('hidden');
            otpCodeInput.value = '';
            phoneNumberInput.focus();
        }


        // --- UI NÉ™zarÉ™ti ---

        /**
         * Ä°stifadÉ™Ã§inin login vÉ™ziyyÉ™tinÉ™ É™sasÉ™n UI-Ä± dÉ™yiÅŸdirin.
         * @param {string | null} userIdentifier - Ä°stifadÉ™Ã§inin telefon nÃ¶mrÉ™si vÉ™ ya UID.
         */
        function checkAuth(userIdentifier) {
            if (userIdentifier && userIdentifier !== 'anonim') {
                authFormSection.classList.add('hidden');
                homeSection.classList.remove('hidden');
                userIdDisplay.innerText = userIdentifier;
                document.getElementById('pageTitle').innerText = "HesabÄ±nÄ±z";
            } else {
                authFormSection.classList.remove('hidden');
                homeSection.classList.add('hidden');
                document.getElementById('pageTitle').innerText = "Telefon ilÉ™ GiriÅŸ";
                // GiriÅŸ formasÄ±na qayÄ±darkÉ™n prosesi sÄ±fÄ±rlayÄ±n
                resetFlow(); 
            }
        }

        // --- Ã‡Ä±xÄ±ÅŸ FunksiyasÄ± ---
        
        window.logout = async function() {
            try {
                await signOut(auth);
                // checkAuth onAuthStateChanged tÉ™rÉ™findÉ™n avtomatik iÅŸÉ™ dÃ¼ÅŸÉ™cÉ™k
                showMessage("UÄŸurla Ã§Ä±xÄ±ÅŸ etdiniz.");
            } catch (error) {
                console.error("Ã‡Ä±xÄ±ÅŸ XÉ™tasÄ±:", error);
                showMessage("Ã‡Ä±xÄ±ÅŸ zamanÄ± xÉ™ta baÅŸ verdi.");
            }
        }

        // SÉ™hifÉ™ yÃ¼klÉ™ndikdÉ™ baÅŸlatÄ±n
        window.addEventListener('load', initializeFirebase);
    </script>
</body>
</html>

